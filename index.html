// 處理發送訊息的函式
      async function sendMessage() {
          if (isWaiting) return;
          const message = userInput.value.trim();
          if (!message) return;

          displayMessage(message, 'user-message');
          userInput.value = '';
          setLoading(true);

          try {
              const requestBody = {
                  chatInput: message,
                  memory: memory 
              };

              const response = await fetch(webhookUrl, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(requestBody)
              });

              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              // 1. 將回傳的 JSON 字串解析成 JavaScript 的陣列
              const data = await response.json();

              // 2. 從回傳的陣列中，取出第一個 (也是唯一一個) 項目
              const responseItem = data[0];

              if (!responseItem) {
                  throw new Error('Received an empty or invalid response from n8n.');
              }

              // 3. (最關鍵的一步！) 用 n8n 回傳的新記憶體，覆蓋掉舊的
              memory = responseItem.memory || {};
              
              // 4. 顯示機器人回覆的訊息
              const replyText = responseItem.reply || "抱歉，我沒有收到有效的回覆。";
              displayMessage(replyText, 'bot-message');

          } catch (error) {
              console.error('Error:', error);
              displayMessage('抱歉，連線發生錯誤，請檢查 n8n workflow 是否已啟用或稍後再試。', 'bot-message');
          } finally {
              setLoading(false);
          }
      }
